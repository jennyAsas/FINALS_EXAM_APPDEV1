<div class="notification-container">
  <h2>Safety Alerts & Notifications</h2>

  <!-- SOS Alert Banner -->
  <div *ngIf="showSosAlert" class="sos-alert">
    <div class="alert-content">
      <strong>{{ sosMessage }}</strong>
      <button (click)="closeAlert()" class="close-btn">&times;</button>
    </div>
  </div>

  <!-- Check if user is logged in -->
  <ng-container *ngIf="currentUser$ | async as user; else notLoggedIn">
    <!-- ADMIN VIEW: SOS Notifications -->
    <ng-container *ngIf="isAdmin$ | async">
      <!-- SOS Detail Modal -->
      <div *ngIf="selectedSOS" class="sos-detail-modal" (click)="closeSOSDetail()">
        <div class="sos-detail-content" (click)="$event.stopPropagation()">
          <div class="sos-detail-header">
            <h3>Emergency SOS Details</h3>
            <button class="modal-close-btn" (click)="closeSOSDetail()">&times;</button>
          </div>

          <div class="sos-detail-body">
            <div class="sos-status-badge" [ngClass]="'status-' + selectedSOS.sosDetails?.status">
              {{ selectedSOS.sosDetails?.status | uppercase }}
            </div>

            <div class="detail-row">
              <span class="detail-label">Reporter Name:</span>
              <span class="detail-value">{{ selectedSOS.sosDetails?.userName }}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Email:</span>
              <span class="detail-value">{{ selectedSOS.sosDetails?.userEmail }}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Time Reported:</span>
              <span class="detail-value">{{
                selectedSOS.sosDetails?.timestamp | date: 'medium'
              }}</span>
            </div>

            <div class="detail-row" *ngIf="selectedSOS.sosDetails?.location">
              <span class="detail-label">GPS Location:</span>
              <span class="detail-value coordinates">
                {{ selectedSOS.sosDetails?.location?.lat?.toFixed(6) }},
                {{ selectedSOS.sosDetails?.location?.lng?.toFixed(6) }}
              </span>
            </div>

            <div class="detail-row" *ngIf="selectedSOS.sosDetails?.location">
              <span class="detail-label">Map Link:</span>
              <a
                class="map-link"
                [href]="
                  'https://www.google.com/maps?q=' +
                  selectedSOS.sosDetails?.location?.lat +
                  ',' +
                  selectedSOS.sosDetails?.location?.lng
                "
                target="_blank"
              >
                Open in Google Maps
              </a>
            </div>
          </div>

          <div class="sos-detail-actions" *ngIf="selectedSOS.sosDetails?.status === 'pending'">
            <button class="action-btn respond-btn" (click)="respondToSOS(selectedSOS.id)">
              Mark as Responded
            </button>
          </div>

          <div class="sos-detail-actions" *ngIf="selectedSOS.sosDetails?.status === 'responded'">
            <button class="action-btn resolve-btn" (click)="resolveSOS(selectedSOS.id)">
              Mark as Resolved
            </button>
          </div>

          <div class="sos-resolved-notice" *ngIf="selectedSOS.sosDetails?.status === 'resolved'">
            This emergency has been resolved.
          </div>
        </div>
      </div>

      <!-- Admin Notifications List -->
      <div
        class="notifications-panel"
        *ngIf="adminNotifications$ | async as notifications; else loading"
      >
        <ng-container *ngIf="notifications.length > 0; else noNotifications">
          <div class="notifications-header">
            <p class="header-title">
              <strong>Emergency SOS Alerts</strong> - You have
              <strong>{{ notifications.length }}</strong> alert(s)
            </p>
            <button (click)="clearAll()" class="clear-btn">Clear All</button>
          </div>

          <div class="notifications-list admin-list">
            <div
              *ngFor="let notification of notifications"
              class="notification-item admin-notification"
              [ngClass]="getNotificationClass(notification)"
              [class.clickable]="notification.sosDetails && (isAdmin$ | async)"
            >
              <div
                class="notification-icon"
                [innerHTML]="getNotificationIcon(notification.type)"
              ></div>

              <div class="notification-content" (click)="onNotificationClick(notification)">
                <p class="notification-message">{{ notification.message }}</p>
                <small class="notification-time">
                  {{ notification.createdAt | date: 'short' }}
                </small>
                <div *ngIf="notification.sosDetails" class="sos-quick-info">
                  <span class="sos-status" [ngClass]="'status-' + notification.sosDetails.status">
                    {{ notification.sosDetails.status | uppercase }}
                  </span>
                  <button
                    class="view-details-btn"
                    (click)="onNotificationClick(notification); $event.stopPropagation()"
                  >
                    View Details
                  </button>
                </div>
              </div>

              <div class="notification-actions">
                <!-- Quick Respond Button for Admin on SOS notifications -->
                <button
                  *ngIf="notification.sosDetails && notification.sosDetails.status === 'pending'"
                  (click)="quickRespondToSOS(notification); $event.stopPropagation()"
                  class="quick-respond-btn"
                  title="Respond to Emergency"
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                    ></path>
                  </svg>
                  Respond
                </button>
                <button
                  *ngIf="!notification.read"
                  (click)="markAsRead(notification.id); $event.stopPropagation()"
                  class="mark-read-btn"
                  title="Mark as read"
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2.5"
                  >
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
                <button
                  (click)="deleteNotification(notification.id); $event.stopPropagation()"
                  class="delete-btn"
                  title="Delete"
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path
                      d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #noNotifications>
          <div class="no-notifications">
            <p>No emergency SOS alerts at this time.</p>
          </div>
        </ng-template>
      </div>
    </ng-container>

    <!-- CITIZEN VIEW: Report Updates & General Alerts -->
    <ng-container *ngIf="!(isAdmin$ | async)">
      <div
        class="notifications-panel"
        *ngIf="citizenNotifications$ | async as notifications; else loading"
      >
        <ng-container *ngIf="notifications.length > 0; else noNotifications">
          <div class="notifications-header">
            <p class="header-title">
              <strong>Your Updates</strong> - You have
              <strong>{{ notifications.length }}</strong> notification(s)
            </p>
            <button (click)="clearAll()" class="clear-btn">Clear All</button>
          </div>

          <div class="notifications-list citizen-list">
            <div
              *ngFor="let notification of notifications"
              class="notification-item citizen-notification"
              [ngClass]="getNotificationClass(notification)"
            >
              <div
                class="notification-icon"
                [innerHTML]="getNotificationIcon(notification.type)"
              ></div>

              <div class="notification-content">
                <p class="notification-message">{{ notification.message }}</p>
                <small class="notification-time">
                  {{ notification.createdAt | date: 'short' }}
                </small>
                <!-- Report status update info -->
                <div *ngIf="notification.reportDetails" class="report-update-info">
                  <span
                    class="report-status"
                    [ngClass]="'status-' + notification.reportDetails.action"
                  >
                    Report {{ notification.reportDetails.action | uppercase }}
                  </span>
                  <p *ngIf="notification.reportDetails.adminNote" class="admin-note">
                    Admin Note: {{ notification.reportDetails.adminNote }}
                  </p>
                </div>
              </div>

              <div class="notification-actions">
                <button
                  *ngIf="!notification.read"
                  (click)="markAsRead(notification.id); $event.stopPropagation()"
                  class="mark-read-btn"
                  title="Mark as read"
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2.5"
                  >
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
                <button
                  (click)="deleteNotification(notification.id); $event.stopPropagation()"
                  class="delete-btn"
                  title="Delete"
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path
                      d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #noNotifications>
          <div class="no-notifications">
            <p>No notifications yet. Stay safe!</p>
          </div>
        </ng-template>
      </div>
    </ng-container>
  </ng-container>

  <!-- Not Logged In State -->
  <ng-template #notLoggedIn>
    <div class="not-logged-in-message">
      <svg
        width="64"
        height="64"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      <h3>Please Log In</h3>
      <p>You need to be logged in to view notifications and safety alerts.</p>
      <p>Log in to receive important updates about your reports and emergency alerts.</p>
    </div>
  </ng-template>

  <ng-template #loading>
    <div class="loading">Loading notifications...</div>
  </ng-template>
</div>
